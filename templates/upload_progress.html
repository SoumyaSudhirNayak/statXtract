
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Progress - {{ filename }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #64748b;
            --primary-gradient: linear-gradient(135deg, #64748b 0%, #475569 100%);
            --secondary-color: #f59e0b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --text-dark: #2d3748;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h2 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-bar-bg {
            width: 100%;
            height: 1.5rem;
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-message {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .file-list {
            margin-top: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            font-weight: 600;
            color: #64748b;
            background-color: #f8fafc;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-pending { background-color: #e2e8f0; color: #64748b; }
        .badge-processing { background-color: #dbeafe; color: #2563eb; }
        .badge-loading_db { background-color: #fef3c7; color: #d97706; }
        .badge-skipped { background-color: #f1f5f9; color: #475569; }
        .badge-completed { background-color: #d1fae5; color: #059669; }
        .badge-failed { background-color: #fee2e2; color: #dc2626; }

        .back-btn {
            display: inline-block;
            margin-top: 2rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary-gradient);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        .back-btn:hover { opacity: 0.9; }
        .back-btn.disabled { pointer-events: none; opacity: 0.5; background: #94a3b8; }
        .step { padding: 8px 10px; border-radius: 10px; background: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; }
        .step.active { background: #dbeafe; border-color: #93c5fd; color: #1d4ed8; font-weight: 600; }
        .step.done { background: #d1fae5; border-color: #6ee7b7; color: #065f46; }

    </style>
</head>
<body>

<div class="container">
    <h2><i class="fas fa-cloud-upload-alt"></i> Uploading: {{ filename }}</h2>
    
    <div class="progress-container">
        <div class="progress-bar-bg">
            <div id="progress-bar" class="progress-bar">0%</div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
            <div id="status-message" class="status-message">Initializing...</div>
            <div id="time-remaining" class="status-message" style="font-weight: 500;"></div>
        </div>
        <div id="stage-row" class="status-message" style="margin-top: 0.25rem; display: none;">
            Stage: <span id="current-stage" style="font-weight: 600;"></span>
        </div>
        <div id="steps" style="margin-top: 0.75rem; display: grid; gap: 6px;">
            <div class="step" data-stage="QUEUED">Queued for conversion</div>
            <div class="step" data-stage="CONVERTING_WITH_NESSTAR">Opening Nesstar study…</div>
            <div class="step" data-stage="EXPORTING_ALL_DATASETS">Exporting ALL datasets (Shift+Ctrl+E)…</div>
            <div class="step" data-stage="EXPORT_DIALOG_OPENED">Export dialog opened — waiting for Save confirmation…</div>
            <div class="step" data-stage="SAVING_DATASETS">Saving exported dataset to workspace…</div>
            <div class="step" data-stage="VALIDATING_EXPORTED_FILES">Export confirmed — validating file…</div>
            <div class="step" data-stage="INGESTING">Loading into PostgreSQL…</div>
            <div class="step" data-stage="COMPLETED">Dataset ready for querying</div>
        </div>
    </div>

    <div class="file-list">
        <h3>Files Status</h3>
        <table>
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Status</th>
                    <th>Rows</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="file-table-body">
                <!-- Rows will be populated by JS -->
            </tbody>
        </table>
    </div>
    
    <div id="error-container" style="color: var(--danger-color); margin-top: 1rem; display: none;"></div>
    <pre id="log-container" style="margin-top: 1rem; white-space: pre-wrap; display: none;"></pre>

    <a href="/upload" id="done-btn" class="back-btn disabled">Upload Another File</a>
</div>

<script>
    const jobId = "{{ job_id }}";
    const statusUrl = `/admin/upload/status/${jobId}`;
    const eventsUrl = `/admin/upload/events/${jobId}`;
    
    const progressBar = document.getElementById('progress-bar');
    const statusMsg = document.getElementById('status-message');
    const timeRemainingMsg = document.getElementById('time-remaining');
    const fileTableBody = document.getElementById('file-table-body');
    const doneBtn = document.getElementById('done-btn');
    const errorContainer = document.getElementById('error-container');
    const stageRow = document.getElementById('stage-row');
    const currentStage = document.getElementById('current-stage');
    const logContainer = document.getElementById('log-container');
    const steps = Array.from(document.querySelectorAll('#steps .step'));

    let startTime = null;
    let isDone = false;
    let eventSource = null;

    function formatTime(seconds) {
        if (seconds < 60) return `${Math.ceil(seconds)}s`;
        const m = Math.floor(seconds / 60);
        const s = Math.ceil(seconds % 60);
        return `${m}m ${s}s`;
    }

    function getBadgeClass(status) {
        const s = String(status || '').toLowerCase();
        switch(s) {
            case 'pending': return 'badge-pending';
            case 'queued': return 'badge-pending';
            case 'processing': return 'badge-processing';
            case 'parsing_ddi': return 'badge-processing';
            case 'extracting': return 'badge-processing';
            case 'converting': return 'badge-loading_db';
            case 'converted': return 'badge-completed';
            case 'ingesting': return 'badge-processing';
            case 'loading_db': return 'badge-loading_db';
            case 'skipped': return 'badge-skipped';
            case 'completed': return 'badge-completed';
            case 'failed': return 'badge-failed';
            default: return 'badge-pending';
        }
    }

    function applyJob(job) {
        const jobStatus = String(job.status || '').toLowerCase();
        const jobState = String(job.current_state || '').toLowerCase();
        const isCompleted = jobStatus === 'completed' || jobState === 'completed';
        const isFailed = jobStatus === 'failed' || jobState === 'failed';
        let progress = job.progress || 0;

        if (isCompleted) progress = 100;

        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;
        statusMsg.textContent = job.message || job.error || "Processing...";

        let stage = String(job.current_state || '').toUpperCase();
        if (isCompleted) {
            stage = 'COMPLETED';
            statusMsg.textContent = 'Ingestion complete';
        }

        if (stage) {
            stageRow.style.display = 'block';
            currentStage.textContent = stage;
        } else {
            stageRow.style.display = 'none';
            currentStage.textContent = '';
        }

        const idx = steps.findIndex(s => (s.getAttribute('data-stage') || '') === stage);
        steps.forEach((el, i) => {
            el.classList.remove('active');
            el.classList.remove('done');
            if (idx >= 0) {
                if (i < idx) el.classList.add('done');
                else if (i === idx) el.classList.add('active');
            }
        });

        if (jobStatus === 'processing' || jobStatus === 'loading_db' || jobStatus === 'converting' || jobStatus === 'ingesting') {
            if (!startTime) startTime = Date.now();

            if (progress > 0 && progress < 100) {
                const elapsed = (Date.now() - startTime) / 1000;
                const estimatedTotal = elapsed / (progress / 100);
                const remaining = estimatedTotal - elapsed;

                if (remaining > 0 && isFinite(remaining)) {
                    timeRemainingMsg.textContent = `Est. remaining: ${formatTime(remaining)}`;
                } else {
                    timeRemainingMsg.textContent = "Calculating...";
                }
            }
        } else if (isCompleted) {
            timeRemainingMsg.textContent = "Completed";
        } else if (jobStatus === 'pending' || jobStatus === 'initialized' || jobStatus === 'queued') {
            timeRemainingMsg.textContent = "Starting...";
        }

        fileTableBody.innerHTML = '';
        if (job.files) {
            job.files.forEach(file => {
                const row = document.createElement('tr');
                const fileStatus = String(file.status || '').toLowerCase();
                const badgeClass = getBadgeClass(fileStatus);
                row.innerHTML = `
                    <td>${file.name}</td>
                    <td><span class="badge ${badgeClass}">${fileStatus.replace('_', ' ').toUpperCase()}</span></td>
                    <td>${file.rows || 0}</td>
                    <td>${file.error || (fileStatus === 'completed' ? '✅' : '...')}</td>
                `;
                fileTableBody.appendChild(row);
            });
        }

        if (job.errors && job.errors.length > 0) {
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = '<strong>Errors:</strong><br>' + job.errors.join('<br>');
        }

        const logs = job.log_messages || job.logs || [];
        if (logs && logs.length > 0) {
            logContainer.style.display = 'block';
            const tail = logs.slice(-30);
            logContainer.textContent = tail.join('\n');
        } else {
            logContainer.style.display = 'none';
            logContainer.textContent = '';
        }

        if (isCompleted || isFailed) {
            isDone = true;
            doneBtn.classList.remove('disabled');
            doneBtn.textContent = isCompleted ? "Upload Another File" : "Back to Upload";
            if (isCompleted) {
                progressBar.style.background = 'var(--success-color)';
            } else {
                progressBar.style.background = 'var(--danger-color)';
            }
            if (eventSource) {
                try { eventSource.close(); } catch (e) {}
                eventSource = null;
            }
        }
    }

    function startSse() {
        try {
            eventSource = new EventSource(eventsUrl);
            eventSource.onmessage = function (event) {
                if (!event || !event.data) return;
                try {
                    const job = JSON.parse(event.data);
                    if (job && job.error) return;
                    applyJob(job);
                } catch (e) {}
            };
            eventSource.onerror = function () {
                try { eventSource.close(); } catch (e) {}
                eventSource = null;
            };
        } catch (e) {}
    }

    async function pollStatus() {
        if (isDone) return;
        try {
            const response = await fetch(statusUrl);
            if (!response.ok) throw new Error("Failed to fetch status");

            const job = await response.json();
            applyJob(job);

            if (isDone) return;
            setTimeout(pollStatus, 1000);
        } catch (e) {
            console.error(e);
            statusMsg.textContent = "Error polling status";
            statusMsg.style.color = "red";
        }
    }

    startSse();
    pollStatus();
</script>

</body>
</html>
